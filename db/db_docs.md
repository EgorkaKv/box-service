# Техническая документация по базе данных проекта "YeeDee"

## Содержание

1. [Обзор проекта](#1-Обзор-проекта)
    1. [Цель](#11-цель)
    2. [Основные участники (Actors)](#12-основные-участники-actors)
    3. [Ключевые сценарии использования](#13-ключевые-сценарии-использования)
        1. [Сценарий Покупателя (Customer Journey)](#131-сценарий-покупателя-customer-journey)
        2. [Сценарий Сотрудника (Staff Journey)](#132-сценарий-сотрудника-staff-journey)
2. [Архитектура и схема данных (ERD)](#2-архитектура-и-схема-данных-erd)
    1. [Описание таблиц](#21-описание-таблиц)
        1. [Таблица `customer`](#211-таблица-customer)
        2. [Таблица `business`](#212-таблица-business)
        3. [Таблица `store`](#213-таблица-store)
        4. [Таблица `store_credential`](#214-таблица-store_credential)
        5. [Таблица `box_template`](#215-таблица-box_template)
        6. [Таблица `surprise_box`](#216-таблица-surprise_box)
        7. [Таблица `orders`](#217-таблица-orders)
        8. [Таблица `payment`](#218-таблица-payment)
        9. [Таблица `delivery`](#219-таблица-delivery)
        10. [Таблица `customer_report`](#2110-таблица-customer_report)
        11. [Таблица `review`](#2111-таблица-review)
    2. [Логика денормализации](#22-логика-денормализации)
3. [Функции и триггеры](#3-функции-и-триггеры)
    1. [Функции](#31-функции)
        1. [`reserve_surprise_box_atomic`](#311-reserve_surprise_box_atomic)
        2. [`cleanup_expired_reservations`](#312-cleanup_expired_reservations)
        3. [`generate_pickup_code`](#313-generate_pickup_code)
        4. [`confirm_box_order`](#314-confirm_box_order)
        5. [`create_box_template`](#315-create_box_template)
        6. [`create_surprise_box_from_template`](#316-create_surprise_box_from_template)
        7. [`expire_surprise_boxes`](#317-expire_surprise_boxes)
    2. [Триггерные функции](#318-триггерные-функции)
    3. [Триггеры](#32-триггеры)
4. [Ключевые бизнес-правила и логика](#4-ключевые-бизнес-правила-и-логика)

## 1. Обзор проекта

### 1.1. Цель

**YeeDee** — это платформа, которая помогает заведениям (пекарням, кафе, бистро) сократить пищевые отходы и убытки,
продавая продукцию с истекающим сроком годности по сниженной цене. Сервис соединяет заведения с покупателями, которые
ищут выгодные предложения на качественную еду.

### 1.2. Основные участники (Actors)

* **Customer (Покупатель):** Конечный пользователь, который ищет, покупает и забирает "сюрприз-боксы" с едой через
  мобильное приложение.
* **Staff (Сотрудник магазина):** Представитель заведения, который управляет шаблонами, создает боксы для продажи,
  отслеживает заказы и выдает их покупателям.

### 1.3. Ключевые сценарии использования

#### 1.3.1. Сценарий Покупателя (Customer Journey)

1. **Поиск:** Покупатель открывает приложение и видит на карте доступные для покупки `surprise_box` в заданном радиусе.
2. **Резервирование:** При нажатии кнопки "Оплатить", система атомарно резервирует выбранный бокс, меняя его статус на
   `reserved`. Это предотвращает покупку одного и того же бокса другими пользователями во время обработки платежа.
3. **Оплата и Подтверждение:** После успешной оплаты статус бокса меняется на `sold`. В системе создается запись в
   таблице `orders`, и для нее генерируется уникальный QR-код (основанный на `pickup_code`).
4. **Получение заказа:** Покупатель приходит в заведение в указанное "окно для самовывоза" (`pickup_start_time` -
   `pickup_end_time`), показывает QR-код заказа в приложении.
5. **Завершение:** Сотрудник сканирует QR-код, подтверждает заказ и выдает товар.

#### 1.3.2. Сценарий Сотрудника (Staff Journey)

1. **Управление товарами:** Сотрудник через интерфейс приложения:
    * Создает `box_template` (шаблоны) для разных типов "сюрприз-боксов".
    * На основе этих шаблонов генерирует конкретное количество `surprise_box` (товаров), которые поступают в продажу.
2. **Обработка заказов:** Сотрудник видит список оплаченных заказов.
3. **Выдача товара:** Когда покупатель приходит за заказом, сотрудник сканирует QR-код. Система проверяет подлинность
   заказа. После успешной проверки сотрудник отдает бокс и помечает заказ в системе как `completed`.

---

## 2. Архитектура и схема данных (ERD)

Система построена на реляционной базе данных PostgreSQL с использованием расширения PostGIS для эффективной работы с
геоданными. Архитектура использует денормализацию в ключевой таблице `surprise_box` для оптимизации наиболее частых
запросов (поиск боксов поблизости).

### 2.1. Описание таблиц

| Таблица              | Назначение                                                   | Ключевые поля и примечания                                                                                                                        |
|:---------------------|:-------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------|
| **customer**         | Хранит информацию о покупателях.                             | `id`, `email`, `phone`                                                                                                                            |
| **business**         | Представляет бизнес-сущность (бренд, сеть).                  | `id`, `business_name`. Используется для группировки магазинов одного бренда.                                                                      |
| **store**            | Физическая точка продажи (магазин, кафе).                    | `id`, `business_id`, `address`, `location (GEOMETRY)`. Привязана к `business`.                                                                    |
| **store_credential** | Учетные данные для входа сотрудников магазина.               | `store_id`, `hash_credentials`. Одна учетная запись на магазин.                                                                                   |
| **category**         | Справочник категорий товаров (напр. "Выпечка", "Супы").      | `id`, `name`.                                                                                                                                     |
| **box_template**     | **Шаблон** для создания `surprise_box`.                      | `store_id`, `template_name`, `original_price`, `discounted_price`. Жестко привязан к `store`. Не удаляется, а деактивируется (`is_active=false`). |
| **surprise_box**     | **Основная сущность - товар**. Отдельная единица на продажу. | `box_template_id`, `status`. **Сильно денормализована** для быстрого поиска. Содержит скопированные данные из `store` и `business`.               |
| **orders**           | Заказ, созданный после успешной оплаты.                      | `customer_id`, `surprise_box_id`, `status`, `pickup_code`. Связывает покупателя и купленный бокс.                                                 |
| **payment**          | Информация о платеже по заказу.                              | `order_id`, `amount`, `payment_status`.                                                                                                           |
| **delivery**         | Информация о доставке (если применимо).                      | `order_id`, `delivery_address`, `status`.                                                                                                         |
| **review**           | Отзывы покупателей на заказы.                                | `order_id`, `rating`.                                                                                                                             |
| **customer_report**  | Жалобы и обращения от пользователей.                         | `customer_id`, `order_id`, `description`.                                                                                                         |

Конечно! Это абсолютно правильный подход для создания исчерпывающей и полезной документации.

Вот расширенная версия документации. Я объединил всю предоставленную вами информацию и детально расписал каждую таблицу,
ее поля и индексы.

---

### 2.1.1 Таблица `customer`

Хранит информацию о зарегистрированных покупателях.

| Поле                            | Тип               | Описание                                                                   |
|:--------------------------------|:------------------|:---------------------------------------------------------------------------|
| **id**                          | `BIGSERIAL`       | **Primary Key.** Уникальный идентификатор покупателя.                      |
| **email**                       | `TEXT UNIQUE`     | Уникальный email, используется для входа и коммуникации.                   |
| **customer_name**               | `TEXT NOT NULL`   | Имя покупателя, отображаемое в системе.                                    |
| **phone**                       | `TEXT UNIQUE`     | Уникальный номер телефона, может использоваться для входа или уведомлений. |
| **gender**                      | `CUSTOMER_GENDER` | Пол покупателя (`'male'`, `'female'`, `'other'`).                          |
| **profile_image_url**           | `TEXT`            | URL-адрес аватара пользователя.                                            |
| **registration_date**           | `TIMESTAMP`       | Дата и время регистрации. По умолчанию `CURRENT_TIMESTAMP`.                |
| **last_login**                  | `TIMESTAMP`       | Дата и время последнего входа в систему.                                   |
| **push_notifications_enabled**  | `BOOLEAN`         | Флаг, разрешил ли пользователь получать push-уведомления.                  |
| **email_notifications_enabled** | `BOOLEAN`         | Флаг, разрешил ли пользователь получать email-рассылки.                    |

**Индексы:**

* Кроме автоматически создаваемых индексов для `PRIMARY KEY` (id) и `UNIQUE` (email, phone), специальных индексов для
  данной таблицы не определено, так как поиск по другим полям не является частой операцией.

### 2.1.2 Таблица `business`

Представляет бизнес-сущность (бренд, сеть заведений). Используется для группировки магазинов (`store`).

| Поле                    | Тип             | Описание                                                    |
|:------------------------|:----------------|:------------------------------------------------------------|
| **id**                  | `BIGSERIAL`     | **Primary Key.** Уникальный идентификатор бизнеса.          |
| **business_name**       | `TEXT NOT NULL` | Название бренда или сети.                                   |
| **business_type**       | `BUSINESS_TYPE` | Тип бизнеса (`'single'`, `'chain'`, `'multi_chain'`).       |
| **description**         | `TEXT`          | Описание бизнеса.                                           |
| **website_url**         | `TEXT`          | Ссылка на официальный сайт.                                 |
| **logo_url**            | `TEXT`          | Ссылка на логотип бренда.                                   |
| **registration_date**   | `TIMESTAMP`     | Дата регистрации в системе.                                 |
| **last_login**          | `TIMESTAMP`     | Дата последнего входа представителя бизнеса.                |
| **registration_number** | `TEXT`          | Юридический регистрационный номер компании.                 |
| **legal_address**       | `TEXT`          | Юридический адрес компании.                                 |
| **updated_at**          | `TIMESTAMP`     | Время последнего обновления записи (обновляется триггером). |

**Индексы:**

| Индекс                | Тип    | Описание                            |
|:----------------------|:-------|:------------------------------------|
| **idx_business_name** | B-tree | Ускоряет поиск бизнеса по названию. |

### 2.1.3 Таблица `store`

Хранит информацию о конкретной физической точке продажи (магазин, кафе, пекарня).

| Поле                | Тип                     | Описание                                                                                                                                     |
|:--------------------|:------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------|
| **id**              | `BIGSERIAL`             | **Primary Key.** Уникальный идентификатор магазина.                                                                                          |
| **business_id**     | `BIGINT`                | **Foreign Key** к `business.id`. Указывает на принадлежность к бренду. `ON DELETE CASCADE`: при удалении бизнеса удаляются все его магазины. |
| **address**         | `TEXT NOT NULL`         | Физический адрес магазина.                                                                                                                   |
| **city**            | `TEXT NOT NULL`         | Город, в котором находится магазин.                                                                                                          |
| **location**        | `GEOMETRY(POINT, 4326)` | Географические координаты (долгота, широта) для поиска на карте. `4326` — стандарт WGS 84.                                                   |
| **description**     | `TEXT`                  | Описание конкретного магазина.                                                                                                               |
| **store_image_url** | `TEXT`                  | URL-адрес основного изображения магазина.                                                                                                    |
| **box_image_url**   | `TEXT`                  | URL-адрес изображения, используемого **по умолчанию** для сюрприз-боксов этого магазина, если не указано иное.                               |
| **opening_hours**   | `JSONB`                 | Часы работы магазина в формате JSON. Например: `{"monday": "09:00-21:00", ...}`.                                                             |
| **is_active**       | `BOOLEAN`               | Флаг, активен ли магазин в системе.                                                                                                          |
| **created_at**      | `TIMESTAMP`             | Дата создания записи.                                                                                                                        |
| **updated_at**      | `TIMESTAMP`             | Время последнего обновления записи (обновляется триггером).                                                                                  |

**Индексы:**

| Индекс                    | Тип    | Описание                                                                               |
|:--------------------------|:-------|:---------------------------------------------------------------------------------------|
| **idx_store_business_id** | B-tree | Ускоряет поиск всех магазинов, принадлежащих одному бизнесу.                           |
| **idx_store_city**        | B-tree | Оптимизирует фильтрацию магазинов по городу.                                           |
| **idx_store_location**    | GIST   | Ускоряет гео-пространственные запросы (например, "найти все магазины в радиусе 5 км"). |

### 2.1.4 Таблица `store_credential`

Хранит учетные данные для входа сотрудников магазина. Предполагается одна общая учетная запись на магазин.

| Поле                              | Тип             | Описание                                                                                  |
|:----------------------------------|:----------------|:------------------------------------------------------------------------------------------|
| **id**                            | `BIGSERIAL`     | **Primary Key.**                                                                          |
| **store_id**                      | `BIGINT`        | **Foreign Key** к `store.id`. `ON DELETE CASCADE`.                                        |
| **employee_role**                 | `EMPLOYEE_ROLE` | Роль (`'staff'`, `'manager'`).                                                            |
| **credentials**                   | `TEXT`          | Логин для входа в систему.                                                                |
| **hash_credentials**              | `TEXT NOT NULL` | **Хеш пароля**. Пароль в открытом виде не хранится.                                       |
| **created_at**                    | `TIMESTAMP`     | Дата создания учетной записи.                                                             |
| **last_login**                    | `TIMESTAMP`     | Время последнего входа.                                                                   |
| **updated_at**                    | `TIMESTAMP`     | Время последнего обновления записи.                                                       |
| `UNIQUE(store_id, employee_role)` | Constraint      | Гарантирует, что у одного магазина может быть только одна учетная запись для каждой роли. |

**Индексы:**

| Индекс              | Тип    | Описание                                                                         |
|:--------------------|:-------|:---------------------------------------------------------------------------------|
| **idx_credentials** | B-tree | Ускоряет поиск учетной записи по логину (`credentials`) во время аутентификации. |

### 2.1.5 Таблица `box_template`

"Чертеж" или шаблон для массового создания однотипных `surprise_box`. Жестко привязан к магазину и не удаляется (только
деактивируется), чтобы сохранять историю.

| Поле                  | Тип             | Описание                                                                         |
|:----------------------|:----------------|:---------------------------------------------------------------------------------|
| **id**                | `BIGSERIAL`     | **Primary Key.**                                                                 |
| **store_id**          | `BIGINT`        | **Foreign Key** к `store.id`. Указывает, какой магазин создал этот шаблон.       |
| **category_id**       | `BIGINT`        | **Foreign Key** к `category.id`. Категория товара.                               |
| **template_name**     | `TEXT NOT NULL` | Название шаблона (напр., "Вечерний набор выпечки").                              |
| **description**       | `TEXT`          | Описание содержимого бокса.                                                      |
| **original_price**    | `INT NOT NULL`  | Оригинальная цена товаров в боксе (в копейках/центах).                           |
| **discounted_price**  | `INT NOT NULL`  | Цена продажи бокса со скидкой (в копейках/центах).                               |
| **image_url**         | `TEXT`          | URL-адрес изображения для боксов, созданных по этому шаблону.                    |
| **pickup_start_time** | `TIMESTAMP`     | Начало временного окна, когда можно забрать заказ.                               |
| **pickup_end_time**   | `TIMESTAMP`     | Конец временного окна для самовывоза.                                            |
| **sale_start_time**   | `TIMESTAMP`     | Время, когда боксы по этому шаблону появляются в продаже.                        |
| **sale_end_time**     | `TIMESTAMP`     | Время, когда боксы снимаются с продажи.                                          |
| **usage_count**       | `INTEGER`       | Счетчик, сколько раз боксы по этому шаблону были проданы. Обновляется триггером. |
| **is_active**         | `BOOLEAN`       | Флаг, можно ли использовать этот шаблон для создания новых боксов.               |
| **created_at**        | `TIMESTAMP`     | Дата создания шаблона.                                                           |
| **updated_at**        | `TIMESTAMP`     | Время последнего обновления записи.                                              |

**Индексы:**

| Индекс                            | Тип              | Описание                                                                         |
|:----------------------------------|:-----------------|:---------------------------------------------------------------------------------|
| **idx_box_template_store_active** | B-tree (Partial) | Ускоряет получение списка только **активных** шаблонов для конкретного магазина. |

### 2.1.6 Таблица `surprise_box`

**Ключевая сущность системы.** Представляет собой отдельную единицу товара (один бокс) на продажу. Таблица сильно
денормализована для максимальной производительности поисковых запросов с UI.

| Поле                       | Тип                     | Описание                                                                                                     |
|:---------------------------|:------------------------|:-------------------------------------------------------------------------------------------------------------|
| **id**                     | `BIGSERIAL`             | **Primary Key.**                                                                                             |
| **box_template_id**        | `BIGINT`                | **Foreign Key** к `box_template.id`. Указывает, по какому шаблону создан бокс.                               |
| **store_id**               | `BIGINT`                | **Foreign Key** к `store.id`.                                                                                |
| **category_id**            | `BIGINT`                | **Foreign Key** к `category.id`.                                                                             |
| **business_name**          | `TEXT NOT NULL`         | *[Денормализация]* Скопировано из `business.business_name`.                                                  |
| **store_address**          | `TEXT NOT NULL`         | *[Денормализация]* Скопировано из `store.address`.                                                           |
| **store_city**             | `TEXT NOT NULL`         | *[Денормализация]* Скопировано из `store.city`.                                                              |
| **store_location**         | `GEOMETRY(POINT, 4326)` | *[Денормализация]* Скопировано из `store.location`. Ключевое поле для гео-поиска.                            |
| **title**                  | `TEXT NOT NULL`         | Название бокса, скопировано из `box_template.template_name`.                                                 |
| **description**            | `TEXT`                  | Описание, скопировано из `box_template.description`.                                                         |
| **category_name**          | `TEXT`                  | *[Денормализация]* Название категории, скопировано из `category.name`.                                       |
| **original_price**         | `INT NOT NULL`          | Скопировано из `box_template.original_price`.                                                                |
| **discounted_price**       | `INT NOT NULL`          | Скопировано из `box_template.discounted_price`.                                                              |
| **image_url**              | `TEXT`                  | Скопировано из `box_template.image_url`.                                                                     |
| **pickup_start_time**      | `TIMESTAMP`             | Скопировано из `box_template`.                                                                               |
| **pickup_end_time**        | `TIMESTAMP`             | Скопировано из `box_template`.                                                                               |
| **sale_start_time**        | `TIMESTAMP`             | Скопировано из `box_template`.                                                                               |
| **sale_end_time**          | `TIMESTAMP`             | Скопировано из `box_template`.                                                                               |
| **status**                 | `BOX_STATUS`            | Статус бокса: `'draft'`, `'active'`, `'reserved'`, `'sold'`, `'expired'`, `'cancelled'`.                     |
| **reserved_by**            | `BIGINT`                | **Foreign Key** к `customer.id`. ID покупателя, который зарезервировал бокс. `NULL`, если не зарезервирован. |
| **reserved_at**            | `TIMESTAMP`             | Время начала резервации.                                                                                     |
| **reservation_expires_at** | `TIMESTAMP`             | Время, когда резервация истечет.                                                                             |
| **created_at**             | `TIMESTAMP`             | Время создания записи.                                                                                       |
| **updated_at**             | `TIMESTAMP`             | Время последнего обновления записи.                                                                          |

**Индексы:**

| Индекс                           | Тип              | Описание                                                                                                 |
|:---------------------------------|:-----------------|:---------------------------------------------------------------------------------------------------------|
| **idx_surprise_box_geo_active**  | GIST (Partial)   | **Ключевой индекс производительности.** Ускоряет гео-поиск **только активных** боксов на главном экране. |
| **idx_surprise_box_city_status** | B-tree (Partial) | Ускоряет фильтрацию активных боксов по городу.                                                           |
| **idx_surprise_box_store_id**    | B-tree           | Оптимизирует поиск всех боксов (включая проданные) для конкретного магазина.                             |
| **idx_surprise_box_reserved_by** | Unique (Partial) | Гарантирует на уровне БД, что один бокс не может быть зарезервирован двумя пользователями одновременно.  |

### 2.1.7 Таблица `orders`

Центральная таблица для отслеживания покупок. Запись создается после успешной оплаты зарезервированного `surprise_box`.

| Поле                 | Тип                | Описание                                                                                                                                               |
|:---------------------|:-------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------|
| **id**               | `BIGSERIAL`        | **Primary Key.** Уникальный идентификатор заказа.                                                                                                      |
| **customer_id**      | `BIGINT`           | **Foreign Key** к `customer.id`. Указывает, кто сделал заказ. `ON DELETE CASCADE`: удаление пользователя приведет к удалению всех его заказов.         |
| **surprise_box_id**  | `BIGINT`           | **Foreign Key** к `surprise_box.id`. Указывает, какой именно бокс был куплен. `ON DELETE RESTRICT`: запрещает удаление бокса, если на него есть заказ. |
| **store_id**         | `BIGINT`           | **Foreign Key** к `store.id`. Указывает, в каком магазине был сделан заказ. `ON DELETE RESTRICT`: запрещает удаление магазина, если в нем есть заказы. |
| **status**           | `ORDER_STATUS`     | Текущий статус заказа (`'pending'`, `'paid'`, `'ready_for_pickup'`, `'completed'` и др.). По умолчанию `'pending'`.                                    |
| **payment_type**     | `PAYMENT_TYPE`     | Тип оплаты (`'app'` - через приложение, `'cash'` - наличными).                                                                                         |
| **fulfillment_type** | `FULFILLMENT_TYPE` | Способ получения заказа (`'pickup'` - самовывоз, `'delivery'` - доставка).                                                                             |
| **pickup_code**      | `TEXT UNIQUE`      | Уникальный код (основа для QR-кода), который покупатель предъявляет для получения заказа. Генерируется функцией.                                       |
| **order_date**       | `TIMESTAMP`        | Дата и время создания заказа. По умолчанию `CURRENT_TIMESTAMP`.                                                                                        |
| **pickuped_at**      | `TIMESTAMP`        | Фактическое время, когда покупатель забрал заказ. Заполняется сотрудником.                                                                             |
| **cancelled_by**     | `CANCELLER_TYPE`   | Кто отменил заказ (`'customer'` или `'store'`).                                                                                                        |
| **cancelled_at**     | `TIMESTAMP`        | Время отмены заказа.                                                                                                                                   |
| **refund_amount**    | `INT`              | Сумма возврата в копейках/центах, если заказ был отменен после оплаты.                                                                                 |

**Индексы:**

| Индекс                    | Тип    | Описание                                                                                  |
|:--------------------------|:-------|:------------------------------------------------------------------------------------------|
| **idx_order_customer_id** | B-tree | Ускоряет поиск всех заказов конкретного покупателя ("Мои заказы").                        |
| **idx_order_store_id**    | B-tree | Ускоряет поиск всех заказов, сделанных в конкретном магазине (для интерфейса сотрудника). |
| **idx_order_status**      | B-tree | Оптимизирует фильтрацию заказов по их статусу (напр., "показать все готовые к выдаче").   |
| **idx_order_date**        | B-tree | Позволяет эффективно сортировать и фильтровать заказы по дате.                            |

### 2.1.8 Таблица `payment`

Хранит детализацию по финансовым транзакциям, связанным с заказами.

| Поле                | Тип              | Описание                                                                                   |
|:--------------------|:-----------------|:-------------------------------------------------------------------------------------------|
| **id**              | `BIGSERIAL`      | **Primary Key.**                                                                           |
| **order_id**        | `BIGINT`         | **Foreign Key** к `orders.id`. Связывает платеж с конкретным заказом. `ON DELETE CASCADE`. |
| **payment_method**  | `PAYMENT_METHOD` | Способ оплаты (`'card'`, `'digital_wallet'`, `'cash'`, `'app'`).                           |
| **amount**          | `INT NOT NULL`   | Сумма платежа в копейках/центах.                                                           |
| **currency**        | `TEXT`           | Валюта платежа. По умолчанию `'UAH'`.                                                      |
| **payment_status**  | `PAYMENT_STATUS` | Статус транзакции (`'pending'`, `'completed'`, `'failed'`, `'refunded'`).                  |
| **transaction_id**  | `TEXT`           | Уникальный идентификатор транзакции от внешней платежной системы (напр., Stripe, LiqPay).  |
| **payment_gateway** | `TEXT`           | Название платежного шлюза, обработавшего транзакцию.                                       |
| **payment_date**    | `TIMESTAMP`      | Точное время успешного завершения платежа.                                                 |
| **refund_date**     | `TIMESTAMP`      | Время, когда был произведен возврат средств.                                               |
| **refund_amount**   | `INT`            | Сумма возврата в копейках/центах.                                                          |
| **updated_at**      | `TIMESTAMP`      | Время последнего обновления записи.                                                        |

**Индексы:**

| Индекс                   | Тип    | Описание                                                                |
|:-------------------------|:-------|:------------------------------------------------------------------------|
| **idx_payment_order_id** | B-tree | Обеспечивает быстрый поиск платежной информации для конкретного заказа. |

### 2.1.9. Таблица `delivery`

Содержит информацию о заказах, которые требуют доставки, а не самовывоза.

| Поле                      | Тип             | Описание                                                                                                                            |
|:--------------------------|:----------------|:------------------------------------------------------------------------------------------------------------------------------------|
| **id**                    | `BIGSERIAL`     | **Primary Key.**                                                                                                                    |
| **order_id**              | `BIGINT UNIQUE` | **Foreign Key** к `orders.id`. Связь с заказом. `UNIQUE` гарантирует, что у одного заказа может быть только одна запись о доставке. |
| **status**                | `TEXT`          | Статус доставки (`'pending_assignment'`, `'assigned'`, `'in_transit'`, `'delivered'` и др.).                                        |
| **delivery_service**      | `TEXT NOT NULL` | Название службы доставки (напр., "Glovo", "Bolt Food").                                                                             |
| **delivery_address**      | `TEXT NOT NULL` | Адрес, по которому нужно доставить заказ.                                                                                           |
| **estimated_delivery_at** | `TIMESTAMP`     | Ожидаемое время доставки.                                                                                                           |
| **delivered_at**          | `TIMESTAMP`     | Фактическое время доставки заказа.                                                                                                  |
| **courier_name**          | `TEXT`          | Имя назначенного курьера.                                                                                                           |
| **courier_phone**         | `TEXT`          | Контактный номер телефона курьера.                                                                                                  |
| **tracking_code**         | `TEXT`          | Трекинг-номер для отслеживания заказа на сайте службы доставки.                                                                     |
| **delivery_fee**          | `INT`           | Стоимость доставки в копейках/центах.                                                                                               |
| **delivery_notes**        | `TEXT`          | Примечания для курьера (напр., "код от домофона 1234").                                                                             |
| **created_at**            | `TIMESTAMP`     | Время создания записи о доставке.                                                                                                   |

**Индексы:**

| Индекс                         | Тип    | Описание                                            |
|:-------------------------------|:-------|:----------------------------------------------------|
| **idx_delivery_order_id**      | B-tree | Ускоряет поиск информации о доставке по ID заказа.  |
| **idx_delivery_tracking_code** | B-tree | Позволяет быстро найти заказ по его трекинг-номеру. |

### 2.1.10 Таблица `customer_report`

Предназначена для сбора и обработки жалоб и обращений от пользователей по различным вопросам.

| Поле               | Тип               | Описание                                                                                                                                    |
|:-------------------|:------------------|:--------------------------------------------------------------------------------------------------------------------------------------------|
| **id**             | `BIGSERIAL`       | **Primary Key.**                                                                                                                            |
| **customer_id**    | `BIGINT`          | **Foreign Key** к `customer.id`. Кто оставил жалобу. `ON DELETE CASCADE`.                                                                   |
| **store_id**       | `BIGINT`          | **Foreign Key** к `store.id`. На какой магазин жалоба. `ON DELETE CASCADE`.                                                                 |
| **order_id**       | `BIGINT`          | **Foreign Key** к `orders.id`. Опциональная связь с заказом. `ON DELETE SET NULL`: если заказ удалят, связь обнулится, но жалоба останется. |
| **report_type**    | `TEXT`            | Тип жалобы (`'service_quality'`, `'food_quality'`, `'app_bug'` и др.).                                                                      |
| **subject**        | `TEXT NOT NULL`   | Краткая тема обращения.                                                                                                                     |
| **description**    | `TEXT NOT NULL`   | Подробное описание проблемы.                                                                                                                |
| **status**         | `REPORT_STATUS`   | Статус обработки жалобы (`'pending'`, `'in_review'`, `'resolved'`, `'rejected'`).                                                           |
| **priority**       | `REPORT_PRIORITY` | Приоритет обращения (`'low'`, `'medium'`, `'high'`).                                                                                        |
| **created_at**     | `TIMESTAMP`       | Время создания жалобы.                                                                                                                      |
| **resolved_at**    | `TIMESTAMP`       | Время, когда жалоба была закрыта.                                                                                                           |
| **admin_response** | `TEXT`            | Ответ администратора или службы поддержки.                                                                                                  |

**Индексы:**

| Индекс                              | Тип    | Описание                                               |
|:------------------------------------|:-------|:-------------------------------------------------------|
| **idx_customer_report_customer_id** | B-tree | Ускоряет поиск всех жалоб от одного пользователя.      |
| **idx_customer_report_store_id**    | B-tree | Ускоряет поиск всех жалоб на один магазин.             |
| **idx_customer_report_order_id**    | B-tree | Ускоряет поиск жалобы, связанной с конкретным заказом. |
| **idx_customer_report_status**      | B-tree | Оптимизирует фильтрацию жалоб по статусу их обработки. |

### 2.1.11. Таблица `review`

Хранит отзывы и оценки, оставленные покупателями после выполнения заказов.

| Поле               | Тип                 | Описание                                                                                        |
|:-------------------|:--------------------|:------------------------------------------------------------------------------------------------|
| **id**             | `BIGSERIAL`         | **Primary Key.**                                                                                |
| **order_id**       | `BIGINT`            | **Foreign Key** к `orders.id`. Указывает, к какому заказу относится отзыв. `ON DELETE CASCADE`. |
| **rating**         | `SMALLINT NOT NULL` | Оценка от 1 до 5. `CHECK` constraint гарантирует, что значение находится в этом диапазоне.      |
| **review_comment** | `TEXT`              | Текстовый комментарий к отзыву.                                                                 |
| **created_at**     | `TIMESTAMP`         | Время создания отзыва.                                                                          |
| **updated_at**     | `TIMESTAMP`         | Время последнего обновления отзыва (если разрешено редактирование).                             |
| **is_approved**    | `BOOLEAN`           | Флаг для модерации. `TRUE`, если отзыв одобрен и виден всем.                                    |

**Индексы:**

| Индекс                  | Тип    | Описание                                                                     |
|:------------------------|:-------|:-----------------------------------------------------------------------------|
| **idx_review_order_id** | B-tree | Быстрый поиск отзыва по ID заказа.                                           |
| **idx_review_rating**   | B-tree | Позволяет эффективно фильтровать отзывы по рейтингу (напр., для статистики). |

---

Этот формат предоставляет всю необходимую информацию в структурированном и легко читаемом виде, что идеально подходит
для технической документации.

### 2.2. Логика денормализации

Таблица `surprise_box` содержит поля `business_name`, `store_address`, `store_city`, `store_location`, которые дублируют
данные из таблиц `business` и `store`.

* **Причина:** Главный экран приложения выполняет гео-запрос для поиска ближайших боксов. Денормализация позволяет
  избежать дорогостоящих `JOIN` с таблицами `store` и `business` в этом критически важном запросе, значительно повышая
  производительность.
* **Поддержание целостности:** Для синхронизации этих данных используется триггер
  `trigger_sync_surprise_box_store_data`, который автоматически обновляет поля в `surprise_box` при изменении
  соответствующих данных в `store`.

---

## 3. Функции и триггеры

### 3.1. Функции

| Функция                               | Описание                                                                                                                   | Когда и кем вызывается                                           |
|:--------------------------------------|:---------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------|
| **reserve_surprise_box_atomic**       | Атомарно резервирует бокс, меняя его статус на `reserved`. Защищает от "гонки" при одновременной покупке.                  | Бэкенд, когда пользователь инициирует оплату.                    |
| **confirm_box_order**                 | Подтверждает успешный заказ: меняет статус бокса на `sold`, создает записи в `orders`, `payment`, `delivery` (если нужно). | Бэкенд, после получения подтверждения от платежной системы.      |
| **create_box_template**               | Создает новый шаблон для сюрприз-боксов.                                                                                   | Бэкенд, когда сотрудник магазина создает новый шаблон.           |
| **create_surprise_box_from_template** | Создает N экземпляров `surprise_box` на основе шаблона.                                                                    | Бэкенд, когда сотрудник выставляет боксы на продажу.             |
| **cleanup_expired_reservations**      | Освобождает просроченные резервации (возвращает статус `active`).                                                          | Автоматически, через `pg_cron` (рекомендуемый интервал: 3 мин).  |
| **expire_surprise_boxes**             | Помечает непроданные боксы как `expired` по истечении времени продажи.                                                     | Автоматически, через `pg_cron` (рекомендуемый интервал: 15 мин). |

### 3.1.1. `reserve_surprise_box_atomic`

Атомарно резервирует `surprise_box` для конкретного пользователя на заданное время. Использует механизм
`UPDATE ... RETURNING` для защиты от race conditions (гонок состояний).

**Параметры:**

| Параметр                | Тип       | Описание                                   | Обязательный | По умолчанию |
|:------------------------|:----------|:-------------------------------------------|:-------------|:-------------|
| `p_box_id`              | `BIGINT`  | ID бокса, который нужно зарезервировать.   | Да           | -            |
| `p_customer_id`         | `BIGINT`  | ID пользователя, который резервирует бокс. | Да           | -            |
| `p_reservation_minutes` | `INTEGER` | Время резервации в минутах.                | Нет          | `5`          |

**Возвращаемый результат (таблица):**

| Поле         | Тип         | Описание                                                               |
|:-------------|:------------|:-----------------------------------------------------------------------|
| `success`    | `BOOLEAN`   | `TRUE` при успешной резервации, `FALSE` в противном случае.            |
| `message`    | `TEXT`      | Текстовое описание результата операции.                                |
| `expires_at` | `TIMESTAMP` | Время, до которого действует резервация (только при `success = TRUE`). |

**Возможные исходы:**

* **Успех (`success: true`):**
    * `message: 'Reservation successful'`
    * `expires_at: [время окончания резерва]`
    * **Условия:** Бокс существует, имеет статус `'active'`.
* **Неудача (`success: false`):**
    * `message: 'Box not found'` — бокс с таким `p_box_id` не существует.
    * `message: 'Box already reserved'` — бокс уже имеет статус `'reserved'`.
    * `message: 'Box already sold'` — бокс уже имеет статус `'sold'`.
    * `message: 'Box not available for reservation'` — бокс в любом другом статусе (`'expired'`, `'cancelled'` и т.д.).

---

### 3.1.2. `cleanup_expired_reservations`

Находит и отменяет все просроченные резервации, возвращая боксам статус `'active'`, чтобы они снова стали доступны для
покупки. Предназначена для вызова по расписанию (cron).

**Параметры:**

* Нет.

**Возвращаемый результат:**

* `INTEGER`: Количество боксов, у которых была отменена резервация.

---

### 3.1.3. `generate_pickup_code`

Генерирует криптографически случайный и уникальный код выдачи заказа (`pickup_code`) длиной 8 символов. Гарантирует
уникальность в пределах таблицы `orders`.

**Параметры:**

* Нет.

**Логика работы:**

1. Генерирует 8-значный код на основе `random()`, `clock_timestamp()` и счетчика попыток, используя `sha256`.
2. Проверяет, существует ли такой код в таблице `orders`.
3. Если код уникален, возвращает его.
4. Если код уже существует, повторяет попытку.
5. Если уникальный код не удалось сгенерировать за 10 попыток, вызывает исключение (`RAISE EXCEPTION`).

**Возвращаемый результат:**

* `TEXT`: Уникальный 8-значный код в верхнем регистре.

---

### 3.1.4. `confirm_box_order`

Основная транзакционная функция, которая подтверждает покупку после успешной оплаты. Она меняет статус бокса, создает
заказ, платеж и, при необходимости, запись о доставке.

**Параметры:**

| Параметр                  | Тип                | Описание                                                             | Обязательный |
|:--------------------------|:-------------------|:---------------------------------------------------------------------|:-------------|
| `p_box_id`                | `BIGINT`           | ID купленного бокса.                                                 | Да           |
| `p_customer_id`           | `BIGINT`           | ID покупателя.                                                       | Да           |
| `p_store_id`              | `BIGINT`           | ID магазина, в котором был куплен бокс.                              | Да           |
| `p_payment_type`          | `PAYMENT_TYPE`     | Тип оплаты (`'app'`, `'cash'`).                                      | Да           |
| `p_fulfillment_type`      | `FULFILLMENT_TYPE` | Тип получения (`'pickup'`, `'delivery'`).                            | Да           |
| `p_payment_method`        | `PAYMENT_METHOD`   | Метод оплаты (`'card'`, `'cash'` и т.д.).                            | Да           |
| `p_amount`                | `INT`              | Сумма покупки в копейках/центах.                                     | Да           |
| `p_transaction_id`        | `TEXT`             | ID транзакции от платежной системы.                                  | Нет          |
| `p_payment_gateway`       | `TEXT`             | Название платежной системы.                                          | Нет          |
| `p_delivery_address`      | `TEXT`             | Адрес доставки (обязателен, если `p_fulfillment_type = 'delivery'`). | Нет          |
| `p_delivery_service`      | `TEXT`             | Служба доставки.                                                     | Нет          |
| `p_estimated_delivery_at` | `TIMESTAMP`        | Ожидаемое время доставки.                                            | Нет          |
| `p_tracking_code`         | `TEXT`             | Трекинг-код доставки.                                                | Нет          |

**Возвращаемый результат (таблица):**

| Поле          | Тип       | Описание                                               |
|:--------------|:----------|:-------------------------------------------------------|
| `success`     | `BOOLEAN` | `TRUE` при успешном подтверждении, `FALSE` при ошибке. |
| `message`     | `TEXT`    | Текстовое описание результата.                         |
| `order_id`    | `BIGINT`  | ID созданного заказа.                                  |
| `pickup_code` | `TEXT`    | Уникальный код для получения заказа.                   |

**Возможные исходы:**

* **Успех (`success: true`):**
    * `message: 'Order confirmed successfully'`
    * **Условия:** Все проверки пройдены, бокс был зарезервирован этим пользователем, и все записи в БД успешно созданы.
* **Неудача (`success: false`):**
    * `message: 'Invalid amount - must be positive'` — `p_amount` меньше или равен нулю.
    * `message: 'Delivery address is required...'` — тип доставки `'delivery'`, но адрес не указан.
    * `message: 'Customer not found'` / `'Store not found'` — передан несуществующий ID покупателя или магазина.
    * `message: 'Unable to confirm order...'` — бокс не найден, не был зарезервирован этим пользователем, резервация
      истекла или `p_store_id` не совпадает с магазином бокса.
* **Исключение (`EXCEPTION`):** В случае непредвиденной ошибки (например, сбой при генерации `pickup_code`), вся
  транзакция откатывается, и возвращается системная ошибка SQL.

---

### 3.1.5. `create_box_template`

Создает новый шаблон (`box_template`), на основе которого сотрудники могут генерировать сюрприз-боксы. Содержит обширную
валидацию входных данных.

**Параметры:**

| Параметр              | Тип         | Описание                                                                                 | Обязательный |
|:----------------------|:------------|:-----------------------------------------------------------------------------------------|:-------------|
| `p_store_id`          | `BIGINT`    | ID магазина, к которому привязан шаблон.                                                 | Да           |
| `p_category_id`       | `BIGINT`    | ID категории товара.                                                                     | Да           |
| `p_template_name`     | `TEXT`      | Название шаблона.                                                                        | Да           |
| `p_original_price`    | `INT`       | Оригинальная цена (в копейках).                                                          | Да           |
| `p_discounted_price`  | `INT`       | Цена со скидкой (в копейках).                                                            | Да           |
| `p_pickup_start_time` | `TIMESTAMP` | Начало окна для самовывоза.                                                              | Да           |
| `p_pickup_end_time`   | `TIMESTAMP` | Конец окна для самовывоза.                                                               | Да           |
| `p_sale_start_time`   | `TIMESTAMP` | Время начала продаж.                                                                     | Да           |
| `p_sale_end_time`     | `TIMESTAMP` | Время окончания продаж.                                                                  | Да           |
| `p_description`       | `TEXT`      | Описание шаблона.                                                                        | Нет          |
| `p_image_url`         | `TEXT`      | Ссылка на изображение. Если не указана, используется `box_image_url` из таблицы `store`. | Нет          |

**Возвращаемый результат (таблица):**

| Поле          | Тип       | Описание                                         |
|:--------------|:----------|:-------------------------------------------------|
| `success`     | `BOOLEAN` | `TRUE` при успехе, `FALSE` при ошибке валидации. |
| `message`     | `TEXT`    | Описание результата или текст ошибки.            |
| `template_id` | `BIGINT`  | ID созданного шаблона.                           |

**Возможные исходы:**

* **Успех (`success: true`):**
    * `message: 'Box template created successfully'`
* **Неудача (`success: false`):**
    * Сообщения об отсутствующих обязательных параметрах (`'Required parameters cannot be null...'`).
    * Сообщения о некорректных ценах или временных интервалах.
    * `'Store not found'` или `'Category not found'`.
* **Исключение (`EXCEPTION`):** При нарушении уникальности или внешних ключей на уровне БД.

---

### 3.1.6. `create_surprise_box_from_template`

Генерирует и вставляет в таблицу `surprise_box` заданное количество боксов на основе существующего шаблона.

**Параметры:**

| Параметр        | Тип       | Описание                                                 | Обязательный | По умолчанию |
|:----------------|:----------|:---------------------------------------------------------|:-------------|:-------------|
| `p_template_id` | `BIGINT`  | ID шаблона (`box_template`), который нужно использовать. | Да           | -            |
| `p_count`       | `INTEGER` | Количество боксов для создания.                          | Нет          | `1`          |

**Ограничения:**

* `p_count` должен быть в диапазоне от 1 до 50.
* Шаблон с `p_template_id` должен существовать и быть активным (`is_active = TRUE`).

**Возвращаемый результат:**

* `SETOF BIGINT`: Набор ID всех созданных записей в `surprise_box`.

**Исключения (`EXCEPTION`):**

* `'count cant be less than 1'` / `'count cant be more than 50'`.
* `'Template not found or inactive'`.

---

### 3.1.7. `expire_surprise_boxes`

Изменяет статус непроданных боксов на `'expired'`, если их время продажи (`pickup_end_time`) истекло. Предназначена для
вызова по расписанию (cron).

**Параметры:**

* Нет.

**Возвращаемый результат (таблица):**

| Поле              | Тип        | Описание                                         |
|:------------------|:-----------|:-------------------------------------------------|
| `success`         | `BOOLEAN`  | `TRUE` при успехе, `FALSE` при системной ошибке. |
| `message`         | `TEXT`     | Описание результата.                             |
| `expired_count`   | `INTEGER`  | Количество боксов, которым изменен статус.       |
| `expired_box_ids` | `BIGINT[]` | Массив ID боксов, которым изменен статус.        |

**Возможные исходы:**

* `message: 'No boxes to expire'` — если нет боксов, удовлетворяющих условиям.
* `message: 'Successfully expired X surprise boxes'` — при успешном выполнении.
* `message: 'Error expiring boxes: ...'` — в случае непредвиденной ошибки БД.

---

### 3.1.8. Триггерные функции

* **`sync_surprise_box_store_data()`**
    * **Назначение:** Поддерживает денормализованные данные в `surprise_box` в актуальном состоянии.
    * **Событие:** Вызывается триггером `trigger_sync_surprise_box_store_data` после `UPDATE` на таблице `store`.
    * **Логика:** Если в `store` изменился адрес, город, координаты или связанное имя бизнеса, функция обновляет
      соответствующие поля во всех `surprise_box`, привязанных к этому магазину.

* **`increment_template_usage()`**
    * **Назначение:** Ведет статистику популярности шаблонов.
    * **Событие:** Вызывается триггером `trigger_increment_template_usage` после `UPDATE` на таблице `surprise_box`.
    * **Логика:** Если статус бокса меняется на `'sold'` (и не был `'sold'` ранее), функция увеличивает на 1 счетчик
      `usage_count` у связанного `box_template`.

* **`update_updated_at_column()`**
    * **Назначение:** Автоматизирует обновление поля `updated_at`.
    * **Событие:** Вызывается множеством триггеров перед `UPDATE` на соответствующих таблицах (`business`, `store`,
      `payment` и др.).
    * **Логика:** Просто устанавливает для поля `NEW.updated_at` текущее время `CURRENT_TIMESTAMP`.

### 3.2. Триггеры

| Триггер                                  | Таблица            | Событие         | Назначение                                                                                  |
|:-----------------------------------------|:-------------------|:----------------|:--------------------------------------------------------------------------------------------|
| **trigger_sync_surprise_box_store_data** | `store`            | `AFTER UPDATE`  | Синхронизирует денормализованные данные (`address`, `city` и др.) в таблице `surprise_box`. |
| **trigger_increment_template_usage**     | `surprise_box`     | `AFTER UPDATE`  | Увеличивает счетчик `usage_count` в `box_template`, когда бокс получает статус `sold`.      |
| **update_*_updated_at**                  | (несколько таблиц) | `BEFORE UPDATE` | Автоматически обновляет поле `updated_at` при любом изменении записи.                       |

---

## 4. Ключевые бизнес-правила и логика

* **Один товар = одна запись:** В таблице `surprise_box` каждый бокс представлен отдельной строкой. Это упрощает логику
  резервирования и смены статусов.
* **Логика изображений:** При создании `box_template`, если изображение не предоставлено, система автоматически
  подставляет `box_image_url` из связанной таблицы `store`.
* **Временные окна:**
    * `sale_start_time` / `sale_end_time`: Определяют период, когда бокс видим для покупки в приложении.
    * `pickup_start_time` / `pickup_end_time`: Определяют "окно", в которое покупатель должен забрать свой заказ.
* **Проверка суммы заказа:** Функция `confirm_box_order` **не** выполняет серверную валидацию суммы (`p_amount`).
  Предполагается, что цена берется с фронтенда. Целостность данных обеспечивается тем, что к заказу жестко привязан
  `surprise_box`, из которого всегда можно получить корректную `discounted_price` для сверки или в случае споров.
* **Неизменяемость сущностей:** `box_template` и `surprise_box` никогда не удаляются из базы данных. Вместо этого
  используется смена статуса (`is_active=false`, `status='expired'`), чтобы сохранить исторические данные и целостность
  связей.
